<?php
if (!defined('IN_KKFRAME')) exit();
function get_random_content() {
$text = <<<EOF
我也愿学习蝴蝶，一再的蜕变，一再的祝愿，既不思虑，也不彷徨；既不回顾，也不忧伤。
我们不需要全世界的灯光为我们指路，一朵小火苗足以点亮我们心中的那条路，温暖我们脚下的土地，六千里，任霸气！
人的一生会遇到两个人，一个惊艳了时光，一个温柔了岁月。
侬今葬花人笑痴，他日葬侬知是谁？
我以前只会过一种生活，就是跟别人不一样的生活，后来我觉得原来大部分人选择的生活也是有价值的。
十八岁的生日对于一个男的没什么，因为一个男人需要一辈子去成熟。
我没有得到什么。她没有失去什么。她没有得到什么，我没有失去什么，最恰当的比喻是：梦中捡了一只指环，梦中丢了一只指环。
痛苦的时候要是不能在一起，那还叫伙伴吗！
我们总是被那些表面的抑郁所蒙骗，就像我看见的一些人，开导的都是别人，自杀的都是自己。
上次人工呼吸很不标准啊，我教你正确动作，好吗
不要逃避，灰原，不要逃避，自己的命运。
也许生存在世间的人们都只是在等待一种偶遇，一种适时的相遇，时间对了，你们便会遇上。
更深漏长，独坐黄昏，紫薇花开，谁人是伴？终不过落花人影两相对。
愤怒，并不会使你变强。剑，最要远离的就是感情。
唤起思量，待不思量，怎不思量。
生命是一个过程，可悲的是它不能重来，可喜的是它无需重来。
赏花归去马如飞，去马如飞酒力微，酒力微醒时已暮，醒时已暮赏花归。
从我遇见你的那天起，我所做的每一件事，就是为了靠近你。
天还未黑，云怎敢灰；雨还未下，风怎敢吹；瓜还未熟，秧怎敢枯；花还未落，树怎敢死；你还未嫁，我怎敢老。
你的对手和你是一样的人，会说笑话。爱吃好吃的东西，是同样的儿子、父亲、丈夫、兄弟、姐妹…
对这个世界了解得越多，我就越不满。
“无需赤热的烤架，地狱就是他人。”
一次的正确并不能抵消长久以来犯下的错误
有时失败的一瞬，也许是最真实的一刻。
蓦听的马嘶人语，不甫能盼的他来到，他却又早醺醺的带酒。
有时候我们蒙住眼睛就可以欺骗自己，世界很黑，很安全。
寒冰之镜前，铁蒺与芳华无声绽放。
所有的其他事，爷一概不知。爷只知道，人一颗心，只有那么大。心中已然放下你，便再也容不下旁人。
如果，他没有我好，那你怎么办？如果，他比我好，那，我又怎么办?
你原本打算吃掉我，所以就算被我吃掉，也没资格抱怨吧。
比起分手还是其他什么的，不得不停止对一个人的喜欢才是最痛苦的。
不过是匆匆一夜，那开得极美极张扬的垂丝碧桃花被风雨吹残，落了一地。
歪来歪去,扭来扭去,歪不了扭不了时,大声说:我是喜欢直来直去的。
孤独一人也没关系，只要能发自内心地爱着一个人，人生就会有救。哪怕不能和他生活在一起。
天涯之人无处觅，咫尺之心且珍惜。
想孤身前往去看一场花事。如果午后微雨突袭，你恰好渡船而过，不妨让我们在春柳拂面的桥头相见。
“龙大爷一回头，飞沙走石鬼见愁；龙大爷二回头，天崩地裂水倒流；龙大爷三回头，美女如云任我游……”
相爱着的人又是往往的爱闹意见，反而是漠不相干的人能够互相容忍。
开始总是分分钟都妙不可言，谁都以为热情它永不会减。
我要的只是在我深爱的乱七八糟的城市里发发疯，享受一下人世间的艳俗与繁荣罢了。
你永远都无法叫醒一个装睡的人，除非那个装睡的人自己决定醒来。
常常谈论自己的人，往往只是为了隐藏自己。
无痛不快，无苦何甜，活着，本就是一种修行。
我们称那位衣着暴露的S小姐为"局部真理"，因为真理都是赤裸裸的。
“你这的人们”小王子说，“在一个花园里养了五千朵玫瑰，但是他们却找不到自己所要寻找的东西。”
听过了很多道理，却依然过不好这一生。
敏而好学，不耻下问，是以谓之文也。
世界是一片海，命运是风，所有的相遇和离别，不过是瞬间的波涛。
明月多情应笑我，笑我如今，辜负春心，独自闲行独自吟。
命运这种东西，生来就是要被踏于足下的，如果你还未有力量反抗它，只需怀着勇气等待。
他的品味不在于他买了什么，而在于他的生活风格甚至为人；他拥有的物质不能说明他，他拥有物质的方式才能道出他是个怎么样的人。
不久之后小美就会尊敬我崇拜我爱上我对我欲罢不能
今夜我不会遇见你，今夜我遇见了世上的一切，但不会遇见你。
我遇见那么多人，可为什么偏偏是你，看起来最应该是过客的你，却在我心里占据这么重要的位子。
时间明显的含着恶意，朝我的头上慢慢的流过，我只好咬紧牙根，拼命的忍住不让眼泪掉下来。
《小王子》的结局让我们陷入了两难的猜想：到底是幸福的活着，还是永恒的离别？
小伙砸，你可以叫我大帅哥，虽然这不足以概括我全部的优点，但却可以显现我最大的特点——装逼！
冷酷的面具，是我害怕被拒绝的伪装。但在你面前，我再也装不下去。
恶魔会在你最脆弱的时候夺走你的一切，他不会给予你怜悯，也不会给予你希望，只会带你进入更黑暗的深渊。
作为你的光下之影，我要让你成为日本第一。
我用我的未来来衡量我的过去，但发现两者都是出色的，彼此不相伯仲，只是我必须谴责天意的不公，它是那样善待我。
你眼前的我是红尘万丈，我眼中的你是化外一方，若你跳的出去，且安心做你的和尚，若你跳不出去，就和我在红尘里相爱一场。
时间的齿轮从未停止转动，它用一种最冷酷和理智的方式，让每个生命得以平行前进。
“张起灵，我已经替你守了他十年，解家不做亏本的买卖，剩下的一辈子，要由你来守候。”
心有灵犀应该是指：在相同的时刻有相同的想法，一眼能看到对方的心底。
然后就是，连我自己都已经厌烦了的，这份天真。
今天中午气得吃了三碗，肚子胀得很，放了工还要去狠狠吃东西，谁教宋清如不给信我
一次次逃离的闪念，就是这样无法预知，无从招架，或许你早已被它们悄然逆转，或许你早已将它们轻轻遗忘。
她的爱沉浸在海底。就如白日焰火，旁人无从察觉，可是一直在努力绽放。
那一天，人类终于回想起曾经一度被他们所支配的恐怖，还有囚禁于鸟笼中的那份屈辱
偏见让你无法接受我，傲慢让我无法爱上你
以关怀代替质问，以建议代替责难，以暗示代替直言。
哪会有人喜欢孤独，只不过不想失望罢了。
太早的炫耀，太急切的追求，虽然可以在眼前给我们一种陶醉的幻境，但是，没有根柢的陶醉毕竟也只能是短暂的幻境而已。
要做淡定的一小撮，而不是狂热的大多数。
生活啊，你只需要知道概况，不能深究细节，把一切都看清楚了，活着也挺没劲的。
男人永远是女人进步的工具，而我愿意作为女人进步的阶梯，来，从我身上踏过去，要狠。
当你怒吼的时候，诸王都只能跪拜
看来你是不见棺材不落泪不到黄河心不死欲穷千里目更上一层楼呢
如果尚有余力，就去保护美好的东西。
因为怎么努力都没办法到任何地方，所以到这地步，只好彼此觉悟。
他们以为自己活着，全凭他们想要的东西，可实际上呢，支配他们的是他们害怕的东西，是他们不想要的东西。
可以轻易地从别人那里得到的东西，一定是伪物。能从别人那里轻易获得之物，也一定会被别人轻易夺去。
你不经意的一个微笑或许成了另一个人的世界。
EOF;
    $contents = explode("\n", $text);
    $content = $contents[array_rand($contents)];
    return $content;
}
function get_random_tid($tieba) {
    $contents = _get_redirect_data('http://tieba.baidu.com/f?kw=' . urlencode($tieba) . '&fr=index');
    $contents = str_replace('class=" j_thread_list','class="j_thread_list',$contents);
    preg_match_all('/<li class="j_thread_list[A-z0-9 -_]+" data-field=\'{(?<json>.*?)}\'/', $contents, $jsontids);
    foreach ($jsontids['json'] as $jsontid) {
        $jsontid = str_ireplace('&quot;', '"', '{' . $jsontid . '}');
        $tids[] = json_decode($jsontid)->id;
        $tops[] = json_decode($jsontid)->is_top;
        $goods[] = json_decode($jsontid)->is_good;
    }
    $rnum = mt_rand(0, count($tids) - 1);
    $tid = $tids[$rnum];
    $top = $tops[$rnum];
    $good = $goods[$rnum];
    if ($top == "true") return 'top';
    elseif ($good == "true") return 'good';
    return $tid;
}
function client_rppost($uid, $tieba, $content) {
    $cookie = get_cookie($uid);
    preg_match('/BDUSS=([^ ;]+);/i', $cookie, $matches);
    $bduss = trim($matches[1]);
    if (empty($bduss)) return array(-1, '找不到 BDUSS Cookie');
    $setting = DB::fetch_first("SELECT * FROM xxx_post_setting WHERE uid='{$uid}'");
    if ($setting['client_type'] == 5) $setting['client_type'] = mt_rand(1, 4);
    if (empty($content)) $content = get_random_content();
    if (empty($tieba['tid'])) $tieba['tid'] = get_random_tid($tieba['name']);
    if ($tieba['tid'] == 'top') return array(9, "随机到置顶贴，取消本次回帖。");
    elseif ($tieba['tid'] == 'good') return array(10, "随机到精品贴，取消本次回帖。");
    $formdata = array(
        'BDUSS' => $bduss,
        '_client_id' => 'wappc_1500' . random(9, true) . '_' . random(3, true) ,
        '_client_type' => $setting['client_type'],
        '_client_version' => '8.6.8.0',
        '_phone_imei' => '000000000000000',
        'anonymous' => 1,
        'content' => $content,
        'fid' => $tieba['fid'],
        'kw' => urldecode($tieba['name']) ,
        'model' => 'MI 6',
        'new_vcode' => '1',
        'tbs' => get_tbs($tieba['uid']) ,
        'tid' => $tieba['tid'],
        'timestamp' => TIMESTAMP . '000',
        'vcode_tag' => '12'
    );
    $adddata = '';
    foreach ($formdata as $k => $v) $adddata .= $k . '=' . $v;
    $sign = strtoupper(md5($adddata . 'tiebaclient!!!'));
    $formdata['sign'] = $sign;
    $ch = curl_init('http://c.tieba.baidu.com/c/c/post/add');
    curl_setopt($ch, CURLOPT_HTTPHEADER, array(
        'Content-Type: application/x-www-form-urlencoded',
        'User-Agent: bdtb for Android 8.6.8.0'
    ));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($formdata));
    $re = json_decode(curl_exec($ch), true);
    curl_close($ch);
    if (!$re) return array(0, 'JSON 解析错误');

    switch ($setting['client_type']) {
        case '1':
            $client_res = "iPhone";
            break;
        case '2':
            $client_res = "Android";
            break;
        case '3':
            $client_res = "WindowsPhone";
            break;
        case '4':
            $client_res = "Windows8";
            break;
        default:
            $client_res = "Android";
    }

    switch ($re['error_code']) {
        case '0':
            return array(2, "使用 " . $client_res . ' 客户端发帖成功，<a href="http://tieba.baidu.com/p/' . $tieba['tid'] . '" target="_blank">查看帖子</a>');
            break;
        case '5':
            return array(5, "需要输入验证码，请检查你是否已经关注该贴吧。");
            break;
        case '7':
            return array(7, "您的操作太频繁了！");
            break;
        case '8':
            return array(8, "您已经被封禁");
            break;
        default:
            return array($re['error_code'], $re['error_msg']);
    }
}
